<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>サイコロ勇者と中心極限定理</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for graphing -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts: Inter for clean text, DotGothic16 for a retro game feel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-game { font-family: 'DotGothic16', sans-serif; }
        .hp-bar-bg { background-color: #4a5568; }
        .hp-bar-fill { background-color: #48bb78; transition: width 0.3s ease-in-out; }
        .hp-bar-player-fill { background-color: #4299e1; transition: width 0.3s ease-in-out; }
        .hidden { display: none; }
        .btn-active { background-color: #4A5568; border-bottom: 4px solid #FBBF24; color: #FBBF24; }
        .btn-inactive { color: #9CA3AF; background-color: transparent; border-bottom: 4px solid transparent;}
        .bonus-text { color: #34D399; text-shadow: 0 0 5px #34D399; }
        .penalty-text { color: #F87171; text-shadow: 0 0 5px #F87171; }
        .stat-good { color: #34D399; }
        .stat-ok { color: #FBBF24; }
        .stat-bad { color: #F87171; }
        .n-button {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            background-color: #374151;
            color: #d1d5db;
            font-weight: 600;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .n-button:hover {
            background-color: #4b5563;
        }
        .n-button-selected {
            background-color: #3b82f6;
            color: white;
            border-color: #60a5fa;
        }
        .column-btn {
            width: 1.5rem;
            height: 1.5rem;
            background-color: #4b5563;
            border-radius: 9999px;
            color: white;
            font-weight: bold;
            font-size: 0.875rem;
            line-height: 1.25rem;
            transition: background-color 0.2s;
        }
        .column-btn:hover {
            background-color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-900 text-white p-4 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold font-game text-yellow-400">サイコロ勇者と中心極限定理</h1>
        </header>

        <!-- Mode Selector -->
        <div class="flex justify-center mb-6 border-b border-gray-700">
            <button id="intro-mode-btn" class="font-game py-2 px-6 text-lg btn-active">はじめに</button>
            <button id="hint-mode-btn" class="font-game py-2 px-6 text-lg btn-inactive">ヒント</button>
            <button id="sim-mode-btn" class="font-game py-2 px-6 text-lg btn-inactive">シミュレーション</button>
            <button id="survival-mode-btn" class="font-game py-2 px-6 text-lg btn-inactive">サバイバル</button>
            <button id="mission-mode-btn" class="font-game py-2 px-6 text-lg btn-inactive">ミッション</button>
        </div>

        <!-- Main Content -->
        <main>
            <!-- Introduction Panel -->
            <div id="introduction-panel" class="bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-700 prose prose-invert prose-lg max-w-none">
                <div class="flex flex-col md:flex-row items-center gap-8">
                    <img id="intro-hero-image" src="" alt="サイコロ勇者のドット絵" class="rounded-lg border-4 border-gray-600 w-36 h-36">
                    <div>
                        <h2 class="font-game text-yellow-300">ようこそ、勇者よ！</h2>
                        <p>このゲームは、RPGを楽しみながら統計学の最も重要で美しい定理の一つ「中心極限定理」を体感できる学習ツールです。</p>
                    </div>
                </div>
                
                <h3 class="font-game text-cyan-300 mt-6">中心極限定理とは？</h3>
                <p>すごく簡単に言うと、**「どんなにデタラメなサイコロでも、たくさん振ってその『平均』を取る、という作業を繰り返すと、平均値たちの分布は必ずキレイな釣鐘型（正規分布）に近づいていく」**という法則です。</p>
                <p>このゲームでは、あなたの「攻撃」がこの法則を実証します！</p>

                <h3 class="font-game text-cyan-300 mt-6">操作方法</h3>
                <ol>
                    <li><strong>モード選択:</strong> 上のタブからプレイしたいモードを選びます。</li>
                    <li><strong>武器を選ぶ:</strong> それぞれ出やすい目が違う3種類の武器から1つ選びます。</li>
                    <li><strong>振る数(n)を決める:</strong> 1回の攻撃でサイコロを何個振るか（サンプルサイズ）を決めます。<strong>これが最重要！</strong></li>
                    <li><strong>攻撃！:</strong> ボタンを押して敵を攻撃！あなたの戦いの記録が右のグラフに刻まれていきます。</li>
                </ol>
            </div>
            
            <!-- Hint Panel -->
            <div id="hint-panel" class="hidden bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-700 prose prose-invert prose-lg max-w-none">
                <h2 class="font-game text-yellow-300">攻略のヒントと裏話</h2>
                
                <h3 class="font-game text-cyan-300 mt-6">ヒント</h3>
                <ul>
                    <li>正規分布に近づけると、サバイバルでは攻撃力と回復力が、ミッションでは攻撃力が上がります。</li>
                    <li>`n`を大きくすると、ダメージの分布は正規分布に近づけることができます。</li>
                    <li>実は、どの武器を使っても`n`が大きければ、ダメージの「ばらつき」は小さくなり、結果は安定します。</li>
                    <li>究極の安定を求めるなら...`n`を999にしちゃおう！</li>
                </ul>

                <h3 class="font-game text-cyan-300 mt-6">開発者より (裏話)</h3>
                <ul>
                    <li>このゲームは、`n`を大きくすると、どんな分布（どんな武器）でも標本平均の分布が正規分布に近似できる、という中心極限定理の強力さを体感してほしくて作成しました。</li>
                    <li>ゲームの核は`n`の選択にあります。最終的にはボタンを連打するだけになってしまうかもしれませんが、その裏にある統計学の面白さを少しでも感じて楽しんでいただければ幸いです！</li>
                </ul>
            </div>

            <!-- Game Content Panel -->
            <div id="game-content-container" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700">
                    <div id="control-panel-content">
                        <h2 class="text-2xl font-bold mb-6 font-game text-cyan-400">作戦司令室</h2>
                        <div class="mb-6">
                            <h3 class="text-lg font-bold mb-3 text-cyan-300 flex items-center gap-2">1. 武器を選ぼう <button id="weapon-col-btn" class="column-btn">？</button></h3>
                            <div class="space-y-2" id="weapon-selector">
                                <label class="flex items-center p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition cursor-pointer"><input type="radio" name="weapon" value="normalSword" class="form-radio h-5 w-5 text-cyan-500 bg-gray-900" checked><span class="ml-3 text-white">ノーマルソード <span class="text-xs text-gray-400">(均等)</span></span></label>
                                <label class="flex items-center p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition cursor-pointer"><input type="radio" name="weapon" value="morningStar" class="form-radio h-5 w-5 text-cyan-500 bg-gray-900"><span class="ml-3 text-white">モーニングスター <span class="text-xs text-gray-400">(1と6に偏る)</span></span></label>
                                <label class="flex items-center p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition cursor-pointer"><input type="radio" name="weapon" value="warHammer" class="form-radio h-5 w-5 text-cyan-500 bg-gray-900"><span class="ml-3 text-white">ウォーハンマー <span class="text-xs text-gray-400">(中央にやや偏る)</span></span></label>
                            </div>
                            <div class="mt-4 p-4 bg-gray-900 rounded-lg flex gap-4 items-center">
                                <img id="weapon-image" src="" alt="選択中の武器" class="rounded-lg border-2 border-gray-600 w-20 h-20">
                                <div class="flex-1 relative h-32 min-w-0">
                                    <h4 class="text-sm text-center text-gray-400 mb-2">武器のダメージ確率</h4>
                                    <canvas id="die-dist-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="mb-6">
                            <h3 class="text-lg font-bold mb-3 text-cyan-300 flex items-center gap-2">2. １回の攻撃で振る数 (n) <button id="n-col-btn" class="column-btn">？</button></h3>
                            <div id="n-selector" class="flex flex-wrap items-center gap-2">
                                <!-- Buttons and input are generated by JS -->
                            </div>
                        </div>
                        <div id="action-buttons">
                            <!-- Buttons will be injected here by JS -->
                        </div>
                    </div>
                </div>

                <!-- Right Panels for each mode -->
                <div id="right-panels" class="lg:col-span-2">
                    <!-- Simulation Mode Panel -->
                    <div id="simulation-mode-panel" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700">
                        <h2 class="text-2xl font-bold mb-2 font-game text-yellow-400 flex items-center gap-2">シミュレーション記録 <button id="sim-col-btn" class="column-btn text-lg">？</button></h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 text-center">
                            <div class="bg-gray-900 p-4 rounded-lg"><div class="text-sm text-gray-400">総攻撃回数</div><div id="total-trials" class="text-2xl font-bold text-yellow-400">0</div></div>
                            <div class="bg-gray-900 p-4 rounded-lg"><div class="text-sm text-gray-400 flex items-center justify-center gap-2">ダメージ平均 <button id="mean-col-btn" class="column-btn">？</button></div><div id="mean-of-means" class="text-2xl font-bold text-yellow-400">N/A</div></div>
                            <div class="bg-gray-900 p-4 rounded-lg"><div class="text-sm text-gray-400 flex items-center justify-center gap-2">ダメージのばらつき <button id="stddev-col-btn" class="column-btn">？</button></div><div id="std-dev" class="text-2xl font-bold text-yellow-400">N/A</div></div>
                             <div class="bg-gray-900 p-4 rounded-lg">
                                <div class="text-sm text-gray-400">分布の評価</div>
                                <div class="flex justify-center gap-4 mt-1">
                                    <p class="text-sm">歪度: <span id="sim-skew-display" class="font-bold">0.00</span></p>
                                    <p class="text-sm">尖度: <span id="sim-kurt-display" class="font-bold">3.00</span></p>
                                </div>
                                <p id="sim-normality-feedback" class="text-xs text-gray-500 mt-1 italic">(歪度0, 尖度3が理想)</p>
                            </div>
                        </div>
                        <div id="simulation-log" class="h-24 bg-gray-900 rounded-lg p-2 text-left overflow-y-auto text-base mb-4"></div>
                        <div class="w-full h-80"><canvas id="results-histogram"></canvas></div>
                        <div id="sim-legend" class="mt-4 text-xs text-gray-400 flex flex-wrap justify-center items-center gap-x-4 gap-y-1"></div>
                    </div>

                    <!-- Survival Mode Panel -->
                    <div id="survival-mode-panel" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700">
                        <div id="survival-start-screen">
                            <h2 class="text-2xl font-bold mb-6 font-game text-red-400 flex items-center justify-center gap-2">サバイバルモード <button id="survival-col-btn" class="column-btn text-lg">？</button></h2>
                            <p class="text-gray-300 mb-4">次々と現れるモンスターを倒し、どこまで生き残れるか挑戦しよう！</p>
                            <p class="text-gray-400 mb-2">正規分布の形に近ければ<strong class="bonus-text">攻撃力と回復力</strong>が上がるぞ！</p>
                            <p class="text-gray-400 mb-6">左の司令室で武器と戦術を選び、下のボタンでゲームを開始してください。</p>
                        </div>
                        <div id="survival-game-screen" class="hidden text-center">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h2 class="text-2xl font-bold font-game text-red-400 text-left">WAVE <span id="wave-counter">1</span></h2>
                                    <p class="text-sm text-left text-gray-400">総攻撃回数: <span id="survival-trial-count">0</span></p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm">歪度: <span id="survival-skew-display" class="font-bold">0.00</span></p>
                                    <p class="text-sm">尖度: <span id="survival-kurt-display" class="font-bold">3.00</span></p>
                                    <p class="text-lg">ボーナス: <span id="survival-bonus-display" class="font-bold">x1.00</span></p>
                                </div>
                            </div>
                            <div class="flex justify-around items-end mb-4">
                                <div class="w-1/3 text-center">
                                    <img id="survival-hero-image" src="" alt="勇者" class="mx-auto mb-2 rounded-lg w-24 h-24">
                                    <h3 class="text-xl font-bold text-blue-300">勇者</h3>
                                    <div class="w-full hp-bar-bg rounded-full h-5 mt-1 border-2 border-gray-600"><div id="player-hp-bar" class="hp-bar-player-fill h-full rounded-full"></div></div>
                                    <p id="player-hp-text" class="text-xs mt-1"></p>
                                </div>
                                <div class="text-2xl font-bold font-game">VS</div>
                                <div class="w-1/3 text-center">
                                    <img id="monster-image" src="" alt="モンスター" class="mx-auto mb-2 rounded-lg w-24 h-24">
                                    <h3 id="monster-name" class="text-xl font-bold text-yellow-300"></h3>
                                    <div class="w-full hp-bar-bg rounded-full h-5 mt-1 border-2 border-gray-600"><div id="monster-hp-bar" class="hp-bar-fill h-full rounded-full"></div></div>
                                    <p id="monster-hp-text" class="text-xs mt-1"></p>
                                </div>
                            </div>
                            <div class="relative h-40 mb-2"><canvas id="live-survival-chart"></canvas></div>
                            <div id="combat-log" class="h-24 bg-gray-900 rounded-lg p-2 text-left overflow-y-auto text-base"></div>
                        </div>
                    </div>
                    
                    <!-- Mission Mode Panel -->
                    <div id="mission-mode-panel" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700">
                        <div id="mission-start-screen">
                            <h2 class="text-2xl font-bold mb-6 font-game text-purple-400 flex items-center justify-center gap-2">討伐ミッション <button id="mission-col-btn" class="column-btn text-lg">？</button></h2>
                            <p class="text-gray-300 mb-2">ターゲット: <span class="font-bold text-white">キングゴーレム</span></p>
                            <p class="text-gray-300 mb-2">HP: <span class="font-bold text-white" id="mission-hp-display">120</span></p>
                            <p class="text-gray-300 mb-4">討伐期限: <span class="font-bold text-white" id="mission-turn-display">30</span> ターン</p>
                            <p class="text-gray-400 mb-2">攻撃分布が正規分布に近いほどダメージボーナスが付与される！</p>
                            <p class="text-gray-400 mb-6">限られたターンで強敵を倒せ！安定した高ダメージが鍵だ！</p>
                        </div>
                        <div id="mission-game-screen" class="hidden text-center">
                             <div class="flex justify-between items-start mb-2">
                                <h2 class="text-2xl font-bold font-game text-purple-400">残り <span id="turn-counter">30</span> ターン</h2>
                                <div class="text-right">
                                    <p class="text-sm">歪度: <span id="mission-skew-display" class="font-bold">0.00</span></p>
                                    <p class="text-sm">尖度: <span id="mission-kurt-display" class="font-bold">3.00</span></p>
                                    <p class="text-lg">ダメージボーナス: <span id="mission-bonus-display" class="font-bold">x1.00</span></p>
                                </div>
                             </div>
                            <div class="flex justify-around items-end mb-4">
                                <div class="w-1/3 text-center">
                                     <img id="mission-hero-image" src="" alt="勇者" class="mx-auto mb-2 rounded-lg w-24 h-24">
                                </div>
                                <div class="text-2xl font-bold font-game">VS</div>
                                <div class="w-1/3 text-center">
                                    <img id="mission-golem-image" src="" alt="キングゴーレム" class="mx-auto mb-2 rounded-lg w-24 h-24">
                                    <h3 id="mission-monster-name" class="text-xl font-bold text-yellow-300">キングゴーレム</h3>
                                    <div class="w-full hp-bar-bg rounded-full h-5 mt-1 border-2 border-gray-600"><div id="mission-monster-hp-bar" class="hp-bar-fill h-full rounded-full"></div></div>
                                    <p id="mission-monster-hp-text" class="text-xs mt-1">120 / 120</p>
                                </div>
                            </div>
                            <div class="relative h-40 mb-2"><canvas id="live-mission-chart"></canvas></div>
                            <div id="mission-combat-log" class="h-24 bg-gray-900 rounded-lg p-2 text-left overflow-y-auto text-base"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="survival-game-over-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-2xl p-8 max-w-2xl w-full text-center border-4 border-red-500">
            <h2 class="text-5xl font-bold font-game text-red-500 mb-4">GAME OVER</h2>
            <p class="text-2xl mb-2">最終スコア: <span id="final-score" class="font-bold text-green-400">0</span> ウェーブ</p>
            <div id="game-over-analysis" class="text-gray-300 bg-gray-900 p-4 rounded-lg mb-6"></div>
            <p class="text-gray-400 mb-2">今回の戦闘におけるダメージ分布</p>
            <div class="relative h-64 mb-6"><canvas id="game-over-chart"></canvas></div>
            <button id="restart-survival-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition text-xl">もう一度挑戦する</button>
        </div>
    </div>
    
    <div id="mission-result-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-2xl p-8 max-w-2xl w-full text-center border-4" id="mission-result-border">
            <h2 class="text-5xl font-bold font-game mb-4" id="mission-result-title"></h2>
            <p class="text-gray-400 mb-2">今回の戦闘におけるダメージ分布</p>
            <div class="relative h-64 mb-6"><canvas id="mission-result-chart"></canvas></div>
            <button id="restart-mission-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition text-xl">もう一度挑戦する</button>
        </div>
    </div>

    <div id="column-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-2xl p-8 max-w-lg w-full text-center border-2 border-cyan-400">
            <p id="column-text" class="text-xl"></p>
            <button id="close-column-btn" class="mt-6 w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition">閉じる</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ASSET URLS ---
        const assetUrls = {
            hero: {
                normal: 'https://i.imgur.com/gYw5o37.png',
                hurt: 'https://i.imgur.com/7z2dZ3a.png',
                danger: 'https://i.imgur.com/B1Y2bfl.png'
            },
            slime_1: { 
                name: "スライム",
                normal: 'https://i.imgur.com/a5J2oGI.png',
                hurt: 'https://i.imgur.com/Q2bAm2e.png',
                danger: 'https://i.imgur.com/s09F40N.png'
            },
            slime_2: { 
                name: "ホーンスライム",
                normal: 'https://i.imgur.com/GKPfUDV.png',
                hurt: 'https://i.imgur.com/j3A8n2D.png',
                danger: 'https://i.imgur.com/v8aG2aG.png'
            },
            slime_3: { 
                name: "スライムキング",
                normal: 'https://i.imgur.com/cSo2i59.png',
                hurt: 'https://i.imgur.com/pZ6f3oG.png',
                danger: 'https://i.imgur.com/y3b8B2A.png'
            },
            golem: {
                name: "キングゴーレム",
                normal: 'https://i.imgur.com/fxta4zK.png',
                hurt: 'https://i.imgur.com/fxta4zK.png', // Golem has one state for now
                danger: 'https://i.imgur.com/fxta4zK.png'
            },
            normalSword: 'https://i.imgur.com/5uSjJ1L.png',
            morningStar: 'https://i.imgur.com/eBw1Ygq.png',
            warHammer: 'https://i.imgur.com/G5g2fN5.png'
        };

        // --- DOM Element References ---
        const modeButtons = {
            introduction: document.getElementById('intro-mode-btn'),
            hint: document.getElementById('hint-mode-btn'),
            simulation: document.getElementById('sim-mode-btn'),
            survival: document.getElementById('survival-mode-btn'),
            mission: document.getElementById('mission-mode-btn'),
        };
        const introductionPanel = document.getElementById('introduction-panel');
        const hintPanel = document.getElementById('hint-panel');
        const gameContentContainer = document.getElementById('game-content-container');
        const panels = {
            simulation: document.getElementById('simulation-mode-panel'),
            survival: document.getElementById('survival-mode-panel'),
            mission: document.getElementById('mission-mode-panel'),
        };
        const weaponSelector = document.getElementById('weapon-selector');
        const nSelector = document.getElementById('n-selector');
        const actionButtonsContainer = document.getElementById('action-buttons');
        
        // Sim Panel
        const totalTrialsEl = document.getElementById('total-trials');
        const meanOfMeansEl = document.getElementById('mean-of-means');
        const stdDevEl = document.getElementById('std-dev');
        const simSkewDisplay = document.getElementById('sim-skew-display');
        const simKurtDisplay = document.getElementById('sim-kurt-display');
        const simNormalityFeedback = document.getElementById('sim-normality-feedback');
        const simulationLog = document.getElementById('simulation-log');

        // Survival Panel
        const survivalBonusDisplay = document.getElementById('survival-bonus-display');
        const survivalSkewDisplay = document.getElementById('survival-skew-display');
        const survivalKurtDisplay = document.getElementById('survival-kurt-display');
        const survivalTrialCount = document.getElementById('survival-trial-count');
        const waveCounterEl = document.getElementById('wave-counter');
        const monsterImageEl = document.getElementById('monster-image');
        const monsterNameEl = document.getElementById('monster-name');
        const monsterHpBar = document.getElementById('monster-hp-bar');
        const monsterHpText = document.getElementById('monster-hp-text');
        const playerHpBar = document.getElementById('player-hp-bar');
        const playerHpText = document.getElementById('player-hp-text');
        const combatLog = document.getElementById('combat-log');
        const survivalGameOverModal = document.getElementById('survival-game-over-modal');
        const finalScoreEl = document.getElementById('final-score');
        const gameOverAnalysisEl = document.getElementById('game-over-analysis');
        const restartSurvivalBtn = document.getElementById('restart-survival-btn');
        
        // Mission Panel
        const missionBonusDisplay = document.getElementById('mission-bonus-display');
        const missionSkewDisplay = document.getElementById('mission-skew-display');
        const missionKurtDisplay = document.getElementById('mission-kurt-display');
        const turnCounterEl = document.getElementById('turn-counter');
        const missionMonsterHpBar = document.getElementById('mission-monster-hp-bar');
        const missionMonsterHpText = document.getElementById('mission-monster-hp-text');
        const missionCombatLog = document.getElementById('mission-combat-log');
        const missionResultModal = document.getElementById('mission-result-modal');
        const missionResultBorder = document.getElementById('mission-result-border');
        const missionResultTitle = document.getElementById('mission-result-title');
        const restartMissionBtn = document.getElementById('restart-mission-btn');

        // Column Modal
        const columnModal = document.getElementById('column-modal');
        const columnText = document.getElementById('column-text');
        const closeColumnBtn = document.getElementById('close-column-btn');
        const weaponColBtn = document.getElementById('weapon-col-btn');
        const nColBtn = document.getElementById('n-col-btn');
        const simColBtn = document.getElementById('sim-col-btn');
        const survivalColBtn = document.getElementById('survival-col-btn');
        const missionColBtn = document.getElementById('mission-col-btn');
        const meanColBtn = document.getElementById('mean-col-btn');
        const stddevColBtn = document.getElementById('stddev-col-btn');

        // --- State Variables ---
        let currentMode = 'introduction';
        let simResultsData = [];
        let autoRunInterval = null;
        const diceOutcomes = [1, 2, 3, 4, 5, 6];
        const diceDistributions = {
            normalSword: { label: 'ノーマルソード', probs: [1/6, 1/6, 1/6, 1/6, 1/6, 1/6] },
            morningStar: { label: 'モーニングスター', probs: [0.3, 0.15, 0.1, 0.05, 0, 0.4] },
            warHammer: { label: 'ウォーハンマー', probs: [0.1, 0.083, 0.3, 0.3, 0.167, 0.05] }
        };
        const nValues = [1, 2, 30];
        let currentN = 30;
        let survival_state = {};
        const MISSION_HP = 120;
        const MISSION_TURNS = 30;
        let mission_state = {};

        // --- Chart.js Instances ---
        let dieDistChart, resultsHistogram, gameOverChart, missionResultChart, liveSurvivalChart, liveMissionChart;
        
        // --- WEAPON/MONSTER NAMES & ASSETS ---
        const monsterAssets = {
            slime_1: { name: "スライム", ...assetUrls.slime_1 },
            slime_2: { name: "ホーンスライム", ...assetUrls.slime_2 },
            slime_3: { name: "スライムキング", ...assetUrls.slime_3 }
        };

        // --- Core Functions ---
        function initializeCharts() {
            const commonChartOptions = {
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#9ca3af', font: { size: 10 } } },
                    x: { type: 'linear', grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#9ca3af', font: { size: 10 } } }
                },
                maintainAspectRatio: false
            };

            dieDistChart = new Chart(document.getElementById('die-dist-chart').getContext('2d'), { 
                type: 'bar', 
                data: { labels: diceOutcomes, datasets: [{ data: [], backgroundColor: 'rgba(56, 189, 248, 0.6)' }] }, 
                options: { ...commonChartOptions, scales: { ...commonChartOptions.scales, x: { grid: { display: false }, ticks: { color: '#9ca3af', font: { size: 10 } } } } }
            });
            
            const createMixedChart = (canvasId, barColor = 'rgba(251, 191, 36, 0.6)') => new Chart(document.getElementById(canvasId).getContext('2d'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        { label: '度数', data: [], backgroundColor: barColor, barPercentage: 1.0, categoryPercentage: 1.0 },
                        { label: '理論上の正規分布', data: [], type: 'line', borderColor: 'rgba(255, 99, 132, 1)', backgroundColor: 'transparent', borderWidth: 2, pointRadius: 0, tension: 0.1 },
                        { label: '平均(μ)', data: [], type: 'scatter', backgroundColor: 'rgba(251, 191, 36, 1)', pointRadius: 6, pointStyle: 'triangle', rotation: 0 },
                        { label: '±1σ', data: [], type: 'scatter', backgroundColor: 'rgba(74, 222, 128, 1)', pointRadius: 5, pointStyle: 'circle' },
                        { label: '±2σ', data: [], type: 'scatter', backgroundColor: 'rgba(251, 146, 60, 1)', pointRadius: 5, pointStyle: 'circle' },
                        { label: '±3σ', data: [], type: 'scatter', backgroundColor: 'rgba(239, 68, 68, 1)', pointRadius: 5, pointStyle: 'circle' }
                    ]
                },
                options: commonChartOptions
            });

            resultsHistogram = createMixedChart('results-histogram');
            gameOverChart = createMixedChart('game-over-chart');
            missionResultChart = createMixedChart('mission-result-chart', 'rgba(192, 132, 252, 0.6)');
            liveSurvivalChart = createMixedChart('live-survival-chart', 'rgba(239, 68, 68, 0.6)');
            liveMissionChart = createMixedChart('live-mission-chart', 'rgba(168, 85, 247, 0.6)');
        }

        function switchMode(mode) {
            currentMode = mode;
            
            Object.keys(modeButtons).forEach(key => {
                modeButtons[key].classList.toggle('btn-active', key === mode);
                modeButtons[key].classList.toggle('btn-inactive', key !== mode);
            });
            
            const allPanels = [introductionPanel, gameContentContainer, hintPanel];
            allPanels.forEach(p => p.classList.add('hidden'));

            if (mode === 'introduction') {
                introductionPanel.classList.remove('hidden');
            } else if (mode === 'hint') {
                hintPanel.classList.remove('hidden');
            } else {
                gameContentContainer.classList.remove('hidden');
                Object.keys(panels).forEach(key => {
                    panels[key].classList.toggle('hidden', key !== mode);
                });
                renderActionButtons();
            }
        }

        function renderActionButtons() {
            actionButtonsContainer.innerHTML = '';
            let buttonsHtml = '';
            if (currentMode === 'simulation') {
                buttonsHtml = `
                    <h3 class="text-lg font-bold mb-3 text-cyan-300">3. 攻撃！</h3>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <button id="run-1" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition">1回 攻撃</button>
                        <button id="run-100" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition hidden">100回 攻撃</button>
                        <button id="run-auto" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition hidden">自動で攻撃</button>
                    </div>
                    <button id="unlock-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition mb-2">便利なボタンを解放する？</button>
                    <button id="reset" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">リセット</button>`;
            } else if (currentMode === 'survival') {
                buttonsHtml = `<button id="start-survival-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition text-xl mt-4">ゲーム開始！</button>
                               <button id="survival-attack-btn" class="w-full bg-red-500 hover:bg-red-600 disabled:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg transition text-xl mt-4 hidden">攻撃！</button>`;
            } else if (currentMode === 'mission') {
                buttonsHtml = `<button id="start-mission-btn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg transition text-xl mt-4">ミッション開始！</button>
                               <button id="mission-attack-btn" class="w-full bg-purple-500 hover:bg-purple-600 disabled:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg transition text-xl mt-4 hidden">攻撃！</button>`;
            }
            actionButtonsContainer.innerHTML = buttonsHtml;
            attachActionListeners();
        }
        
        function attachActionListeners() {
            if (currentMode === 'simulation') {
                document.getElementById('run-1').addEventListener('click', () => runSimulation(1));
                const run100Btn = document.getElementById('run-100');
                if (run100Btn) run100Btn.addEventListener('click', () => runSimulation(100));
                const runAutoBtn = document.getElementById('run-auto');
                if (runAutoBtn) runAutoBtn.addEventListener('click', toggleAutoRun);
                document.getElementById('reset').addEventListener('click', resetSimulation);
                document.getElementById('unlock-btn').addEventListener('click', (e) => {
                    e.target.classList.add('hidden');
                    document.getElementById('run-100').classList.remove('hidden');
                    document.getElementById('run-auto').classList.remove('hidden');
                });
            } else if (currentMode === 'survival') {
                document.getElementById('start-survival-btn').addEventListener('click', startSurvival);
                document.getElementById('survival-attack-btn').addEventListener('click', survivalAttack);
            } else if (currentMode === 'mission') {
                document.getElementById('start-mission-btn').addEventListener('click', startMission);
                document.getElementById('mission-attack-btn').addEventListener('click', missionAttack);
            }
        }

        // --- Shared Logic ---
        function calculateMeanDamage() {
            const sampleSize = currentN;
            const selectedWeapon = document.querySelector('input[name="weapon"]:checked').value;
            const probs = diceDistributions[selectedWeapon].probs;
            let currentSample = Array.from({ length: sampleSize }, () => rollWeightedDie(probs));
            return currentSample.reduce((a, b) => a + b, 0) / sampleSize;
        }
        
        function rollWeightedDie(probs) {
            const rand = Math.random();
            let cumulativeProb = 0;
            for (let i = 0; i < probs.length; i++) {
                cumulativeProb += probs[i];
                if (rand < cumulativeProb) return diceOutcomes[i];
            }
            return diceOutcomes[diceOutcomes.length - 1];
        }

        function updateDistributionChart(chartInstance, data) {
            const n_value = currentN;
            const { mean, stdDev } = calculateDistributionStats(data);

            let chartMin, chartMax, numBins;

            if (data.length < 50) {
                chartMin = 1;
                chartMax = 6;
            } else {
                const range = Math.max(0.5, 6 * stdDev);
                chartMin = Math.max(1, mean - range / 2);
                chartMax = Math.min(6, mean + range / 2);
            }
            
            numBins = n_value <= 5 ? 30 : 100;
            
            chartInstance.options.scales.x.min = chartMin;
            chartInstance.options.scales.x.max = chartMax;
            
            const binWidth = (chartMax - chartMin) / numBins;
            const labels = Array.from({length: numBins}, (_, i) => (chartMin + (i + 0.5) * binWidth));
            
            const bins = new Array(numBins).fill(0);
            data.forEach(value => {
                let binIndex = Math.floor((value - chartMin) / binWidth);
                if (binIndex === numBins) binIndex = numBins - 1;
                if (binIndex >= 0 && binIndex < numBins) bins[binIndex]++;
            });

            chartInstance.data.labels = labels.map(l => l.toFixed(2));
            chartInstance.data.datasets[0].data = bins;
            
            const selectedWeapon = document.querySelector('input[name="weapon"]:checked').value;
            const { mu, sigma } = calculateTheoreticalStats(diceDistributions[selectedWeapon].probs);
            const sampleMeanSigma = sigma / Math.sqrt(n_value);

            if (sampleMeanSigma > 0 && data.length > 0) {
                const normalCurveData = labels.map(x => {
                    const exponent = -Math.pow(x - mu, 2) / (2 * Math.pow(sampleMeanSigma, 2));
                    const pdf = (1 / (sampleMeanSigma * Math.sqrt(2 * Math.PI))) * Math.exp(exponent);
                    return pdf * data.length * binWidth;
                });
                chartInstance.data.datasets[1].data = normalCurveData;
                chartInstance.data.datasets[2].data = [{x: mean, y: 0}];
                chartInstance.data.datasets[3].data = [{x: mean + stdDev, y: 0}, {x: mean - stdDev, y: 0}];
                chartInstance.data.datasets[4].data = [{x: mean + 2 * stdDev, y: 0}, {x: mean - 2 * stdDev, y: 0}];
                chartInstance.data.datasets[5].data = [{x: mean + 3 * stdDev, y: 0}, {x: mean - 3 * stdDev, y: 0}];
            } else {
                 chartInstance.data.datasets[1].data = [];
                 chartInstance.data.datasets[2].data = [];
                 chartInstance.data.datasets[3].data = [];
                 chartInstance.data.datasets[4].data = [];
                 chartInstance.data.datasets[5].data = [];
            }
            
            chartInstance.update();
        }

        function updateWeaponDisplay() {
            const selectedWeapon = document.querySelector('input[name="weapon"]:checked').value;
            dieDistChart.data.datasets[0].data = diceDistributions[selectedWeapon].probs;
            dieDistChart.update();
            document.getElementById('weapon-image').src = assetUrls[selectedWeapon];
        }
        
        // --- Simulation Mode Logic ---
        function runSimulation(numTrials) { 
            for (let i = 0; i < numTrials; i++) {
                const damage = calculateMeanDamage();
                simResultsData.push(damage); 
                if (numTrials === 1) {
                    addCombatLog(simulationLog, `${damage.toFixed(2)} のダメージ！`, 'text-yellow-300');
                }
            }
            updateSimUI(); 
        }
        function updateSimUI() { 
            updateSimStatistics(); 
            updateDistributionChart(resultsHistogram, simResultsData); 
            if (simResultsData.length >= 50) {
                const unlockBtn = document.getElementById('unlock-btn');
                if (unlockBtn) unlockBtn.classList.remove('hidden');
            }
        }
        function updateSimStatistics() {
            const n = simResultsData.length;
            totalTrialsEl.textContent = n;
            if (n === 0) { meanOfMeansEl.textContent = 'N/A'; stdDevEl.textContent = 'N/A'; return; }
            const { mean, stdDev, skewness, kurtosis } = calculateDistributionStats(simResultsData);
            meanOfMeansEl.textContent = mean.toFixed(2);
            stdDevEl.textContent = stdDev.toFixed(2);
            updateStatDisplay(null, null, simSkewDisplay, skewness, simKurtDisplay, kurtosis, simNormalityFeedback);
        }
        function resetSimulation() { 
            stopAutoRun(); 
            simResultsData = []; 
            updateSimUI(); 
            simulationLog.innerHTML = '';
            const unlockBtn = document.getElementById('unlock-btn');
            if(unlockBtn) unlockBtn.classList.remove('hidden');
            const run100Btn = document.getElementById('run-100');
            if(run100Btn) run100Btn.classList.add('hidden');
            const runAutoBtn = document.getElementById('run-auto');
            if(runAutoBtn) runAutoBtn.classList.add('hidden');
        }
        function toggleAutoRun() {
            const btn = document.getElementById('run-auto');
            if (autoRunInterval) {
                clearInterval(autoRunInterval); autoRunInterval = null; btn.textContent = '自動で攻撃';
                btn.classList.replace('bg-pink-500', 'bg-green-500');
            } else {
                autoRunInterval = setInterval(() => runSimulation(100), 50); btn.textContent = '停止';
                btn.classList.replace('bg-green-500', 'bg-pink-500');
            }
        }
        function stopAutoRun() {
            if(autoRunInterval) { clearInterval(autoRunInterval); autoRunInterval = null;
                const btn = document.getElementById('run-auto');
                if(btn) { btn.textContent = '自動で攻撃'; btn.classList.replace('bg-pink-500', 'bg-green-500'); }
            }
        }

        // --- Survival Mode Logic ---
        function startSurvival() {
            survival_state = { wave: 1, player: { maxHp: 100, currentHp: 100 }, monster: {}, damageLog: [] };
            document.getElementById('start-survival-btn').classList.add('hidden');
            document.getElementById('survival-attack-btn').classList.remove('hidden');
            document.getElementById('survival-start-screen').classList.add('hidden');
            document.getElementById('survival-game-screen').classList.remove('hidden');
            document.getElementById('survival-attack-btn').disabled = false;
            updateDistributionChart(liveSurvivalChart, []);
            setupNextWave();
        }
        function setupNextWave() {
            const wave = survival_state.wave;
            const monsterAsset = wave < 5 ? monsterAssets.slime_1 : (wave < 10 ? monsterAssets.slime_2 : monsterAssets.slime_3);
            
            survival_state.monster = {
                name: monsterAsset.name,
                maxHp: Math.floor(30 * Math.pow(1.12, wave)),
                currentHp: Math.floor(30 * Math.pow(1.12, wave)),
                attack: Math.floor(3 * Math.pow(1.06, wave)),
                asset: monsterAsset
            };
            monsterImageEl.src = monsterAsset.normal;
            waveCounterEl.textContent = wave;
            updateSurvivalUI();
            document.getElementById('survival-attack-btn').disabled = false;
            addCombatLog(combatLog, `WAVE ${wave} 開始！ ${survival_state.monster.name} が現れた！`, 'text-yellow-400');
        }
        function survivalAttack() {
            const bonus = calculateNormalityBonus(survival_state.damageLog);
            const baseDamage = calculateMeanDamage();
            const finalDamage = baseDamage * bonus;
            survival_state.damageLog.push(baseDamage);
            survival_state.monster.currentHp -= finalDamage;
            
            addCombatLog(combatLog, `勇者の攻撃！ ${baseDamage.toFixed(1)} のダメージ！`, 'text-blue-300');
            if (bonus > 1.1) {
                 addCombatLog(combatLog, `正規分布ボーナス！ ダメージが ${bonus.toFixed(2)}倍に！ (最終: ${finalDamage.toFixed(1)})`, 'bonus-text');
            } else if (bonus < 0.9) {
                 addCombatLog(combatLog, `分布が乱れている！ ダメージが ${bonus.toFixed(2)}倍に減少！ (最終: ${finalDamage.toFixed(1)})`, 'penalty-text');
            }

            updateDistributionChart(liveSurvivalChart, survival_state.damageLog);
            updateSurvivalUI();

            if (survival_state.monster.currentHp <= 0) {
                document.getElementById('survival-attack-btn').disabled = true;
                addCombatLog(combatLog, `${survival_state.monster.name} を倒した！`, 'text-green-400');
                survival_state.wave++;
                const healBonus = calculateNormalityBonus(survival_state.damageLog, true); // Use survival specific bonus
                const baseHeal = 10;
                const healAmount = Math.min(survival_state.player.maxHp - survival_state.player.currentHp, Math.round(baseHeal * healBonus));
                survival_state.player.currentHp += healAmount;
                
                if (healBonus > 1.1) {
                    addCombatLog(combatLog, `正規分布ボーナス！ HP回復量が ${healBonus.toFixed(2)}倍に！ (回復量: ${healAmount})`, 'bonus-text');
                } else if (healBonus < 0.9) {
                    addCombatLog(combatLog, `分布が乱れている！ HP回復量が ${healBonus.toFixed(2)}倍に減少！ (回復量: ${healAmount})`, 'penalty-text');
                } else {
                    addCombatLog(combatLog, `HPが ${healAmount} 回復した。`, 'text-green-300');
                }

                setTimeout(setupNextWave, 1000);
                return;
            }
            const monsterDamage = survival_state.monster.attack;
            survival_state.player.currentHp -= monsterDamage;
            addCombatLog(combatLog, `${survival_state.monster.name}の反撃！ ${monsterDamage} のダメージ！`, 'text-red-400');
            updateSurvivalUI();
            if (survival_state.player.currentHp <= 0) survivalGameOver();
        }
        function updateSurvivalUI() {
            const { bonus, skewness, kurtosis } = getBonusAndStats(survival_state.damageLog, true);
            updateStatDisplay(survivalBonusDisplay, bonus, survivalSkewDisplay, skewness, survivalKurtDisplay, kurtosis);
            survivalTrialCount.textContent = survival_state.damageLog.length;

            playerHpText.textContent = `${Math.max(0, survival_state.player.currentHp).toFixed(0)} / ${survival_state.player.maxHp}`;
            playerHpBar.style.width = `${Math.max(0, survival_state.player.currentHp) / survival_state.player.maxHp * 100}%`;
            document.getElementById('survival-hero-image').src = getCharacterImage(assetUrls.hero, survival_state.player.currentHp, survival_state.player.maxHp);

            monsterNameEl.textContent = survival_state.monster.name;
            monsterHpText.textContent = `${Math.max(0, survival_state.monster.currentHp).toFixed(0)} / ${survival_state.monster.maxHp}`;
            monsterHpBar.style.width = `${Math.max(0, survival_state.monster.currentHp) / survival_state.monster.maxHp * 100}%`;
            if (survival_state.monster.asset) {
                monsterImageEl.src = getCharacterImage(survival_state.monster.asset, survival_state.monster.currentHp, survival_state.monster.maxHp);
            }
        }
        function survivalGameOver() {
            document.getElementById('survival-attack-btn').disabled = true;
            const waveScore = survival_state.wave - 1;
            finalScoreEl.textContent = waveScore;
            
            const { skewness, kurtosis } = calculateDistributionStats(survival_state.damageLog);
            let analysisText = `歪度は ${skewness.toFixed(2)}、尖度は ${kurtosis.toFixed(2)} でした。<br>`;
            if (Math.abs(skewness) < 0.5 && Math.abs(kurtosis - 3) < 0.5) {
                analysisText += "素晴らしい！ほぼ完璧な正規分布です。nを大きく保つ戦略が見事にハマりましたね！";
            } else if (Math.abs(skewness) < 1 && Math.abs(kurtosis - 3) < 1) {
                analysisText += "良い分布です！もう少し試行回数を重ねるか、nを調整すれば、さらにボーナスを狙えたでしょう。";
            } else {
                analysisText += "分布にまだ改善の余地がありそうです。nを大きくして、ダメージを安定させることを意識してみましょう！";
            }
            gameOverAnalysisEl.innerHTML = analysisText;

            updateDistributionChart(gameOverChart, survival_state.damageLog);
            survivalGameOverModal.classList.remove('hidden');
        }
        function restartSurvival() {
            survivalGameOverModal.classList.add('hidden');
            document.getElementById('survival-game-screen').classList.add('hidden');
            document.getElementById('survival-start-screen').classList.remove('hidden');
            document.getElementById('start-survival-btn').classList.remove('hidden');
            document.getElementById('survival-attack-btn').classList.add('hidden');
            combatLog.innerHTML = '';
        }

        // --- Mission Mode Logic ---
        function startMission() {
            mission_state = {
                monster: { name: 'キングゴーレム', maxHp: MISSION_HP, currentHp: MISSION_HP, asset: assetUrls.golem },
                turnsLeft: MISSION_TURNS,
                damageLog: []
            };
            document.getElementById('start-mission-btn').classList.add('hidden');
            document.getElementById('mission-attack-btn').classList.remove('hidden');
            document.getElementById('mission-start-screen').classList.add('hidden');
            document.getElementById('mission-game-screen').classList.remove('hidden');
            document.getElementById('mission-attack-btn').disabled = false;
            updateDistributionChart(liveMissionChart, []);
            updateMissionUI();
            addCombatLog(missionCombatLog, '討伐ミッション開始！', 'text-purple-400');
        }
        function missionAttack() {
            if (mission_state.turnsLeft <= 0) return;
            mission_state.turnsLeft--;
            const baseDamage = calculateMeanDamage();
            const bonus = calculateNormalityBonus(mission_state.damageLog);
            const finalDamage = baseDamage * bonus;
            mission_state.damageLog.push(baseDamage); 
            mission_state.monster.currentHp -= finalDamage;
            
            if (bonus > 1.1) {
                 addCombatLog(missionCombatLog, `正規分布ボーナス！ ダメージが ${bonus.toFixed(2)}倍に！`, 'bonus-text');
            } else if (bonus < 0.9) {
                 addCombatLog(missionCombatLog, `分布が乱れている！ ダメージが ${bonus.toFixed(2)}倍に減少！`, 'penalty-text');
            }
            addCombatLog(missionCombatLog, `残り${mission_state.turnsLeft+1}ターン: ${finalDamage.toFixed(1)} のダメージ！`, 'text-blue-300');
            
            updateDistributionChart(liveMissionChart, mission_state.damageLog);
            updateMissionUI();
            if (mission_state.monster.currentHp <= 0) { missionResult(true); } 
            else if (mission_state.turnsLeft <= 0) { missionResult(false); }
        }
        function updateMissionUI() {
            const { bonus, skewness, kurtosis } = getBonusAndStats(mission_state.damageLog);
            updateStatDisplay(missionBonusDisplay, bonus, missionSkewDisplay, skewness, missionKurtDisplay, kurtosis);

            turnCounterEl.textContent = mission_state.turnsLeft;
            document.getElementById('mission-monster-hp-text').textContent = `${Math.max(0, mission_state.monster.currentHp).toFixed(0)} / ${mission_state.monster.maxHp}`;
            document.getElementById('mission-monster-hp-bar').style.width = `${Math.max(0, mission_state.monster.currentHp) / mission_state.monster.maxHp * 100}%`;
            document.getElementById('mission-golem-image').src = getCharacterImage(mission_state.monster.asset, mission_state.monster.currentHp, mission_state.monster.maxHp);
        }
        function missionResult(isWin) {
            document.getElementById('mission-attack-btn').disabled = true;
            updateDistributionChart(missionResultChart, mission_state.damageLog);
            if (isWin) {
                missionResultTitle.textContent = 'MISSION COMPLETE!';
                missionResultTitle.className = 'text-5xl font-bold font-game mb-4 text-green-400';
                missionResultBorder.className = 'bg-gray-800 rounded-2xl p-8 max-w-2xl w-full text-center border-4 border-green-400';
            } else {
                missionResultTitle.textContent = 'MISSION FAILED';
                missionResultTitle.className = 'text-5xl font-bold font-game mb-4 text-red-500';
                missionResultBorder.className = 'bg-gray-800 rounded-2xl p-8 max-w-2xl w-full text-center border-4 border-red-500';
            }
            missionResultModal.classList.remove('hidden');
        }
        function restartMission() {
            missionResultModal.classList.add('hidden');
            document.getElementById('mission-game-screen').classList.add('hidden');
            document.getElementById('mission-start-screen').classList.remove('hidden');
            document.getElementById('start-mission-btn').classList.remove('hidden');
            document.getElementById('mission-attack-btn').classList.add('hidden');
            missionCombatLog.innerHTML = '';
        }
        
        // --- Utility Functions ---
        function addCombatLog(logEl, message, colorClass) {
            const p = document.createElement('p');
p.textContent = message;
            if (colorClass) p.className = colorClass;
            logEl.appendChild(p);
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function calculateTheoreticalStats(probs) {
            let mu = 0;
            for (let i = 0; i < diceOutcomes.length; i++) {
                mu += diceOutcomes[i] * probs[i];
            }
            let variance = 0;
            for (let i = 0; i < diceOutcomes.length; i++) {
                variance += Math.pow(diceOutcomes[i] - mu, 2) * probs[i];
            }
            return { mu, sigma: Math.sqrt(variance) };
        }

        function calculateDistributionStats(data) {
            const n = data.length;
            if (n < 2) return { mean: data[0] || 0, stdDev: 0, skewness: 0, kurtosis: 3 };
            const mean = data.reduce((a, b) => a + b, 0) / n;
            const stdDev = Math.sqrt(data.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / n);
            if (stdDev === 0 || n < 3) return { mean, stdDev, skewness: 0, kurtosis: 3 };
            const m3 = data.reduce((acc, val) => acc + Math.pow(val - mean, 3), 0) / n;
            const m4 = data.reduce((acc, val) => acc + Math.pow(val - mean, 4), 0) / n;
            const skewness = m3 / Math.pow(stdDev, 3);
            const kurtosis = m4 / Math.pow(stdDev, 4);
            return { mean, stdDev, skewness, kurtosis };
        }
        
        function calculateNormalityBonus(data, isSurvival = false) {
            if (data.length < 5) return 1.0; 
            const { skewness, kurtosis } = calculateDistributionStats(data);
            const error = Math.pow(skewness, 2) + Math.pow(kurtosis - 3, 2);
            const multiplier = isSurvival ? 5 : 3;
            return multiplier * Math.exp(-error);
        }
        
        function getBonusAndStats(data, isSurvival = false) {
            const bonus = calculateNormalityBonus(data, isSurvival);
            const { skewness, kurtosis } = calculateDistributionStats(data);
            return { bonus, skewness, kurtosis };
        }
        
        function updateStatDisplay(bonusEl, bonus, skewEl, skew, kurtEl, kurt, feedbackEl) {
            if (bonusEl) {
                bonusEl.textContent = `x${bonus.toFixed(2)}`;
                bonusEl.className = bonus > 1.1 ? 'font-bold bonus-text' : (bonus < 0.9 ? 'font-bold penalty-text' : 'font-bold');
            }

            skewEl.textContent = skew.toFixed(2);
            kurtEl.textContent = kurt.toFixed(2);
            
            const skewError = Math.abs(skew);
            skewEl.className = skewError < 0.5 ? 'font-bold stat-good' : (skewError < 1 ? 'font-bold stat-ok' : 'font-bold stat-bad');
            
            const kurtError = Math.abs(kurt - 3);
            kurtEl.className = kurtError < 0.5 ? 'font-bold stat-good' : (kurtError < 1 ? 'font-bold stat-ok' : 'font-bold stat-bad');

            if (feedbackEl) {
                if (skewError < 0.5 && kurtError < 0.5) {
                    feedbackEl.textContent = "正規分布に近いぞ！";
                    feedbackEl.className = "text-xs mt-1 italic stat-good";
                } else if (skewError > 1 || kurtError > 1) {
                    feedbackEl.textContent = "分布が乱れている！";
                    feedbackEl.className = "text-xs mt-1 italic stat-bad";
                } else {
                    feedbackEl.textContent = "(歪度0, 尖度3が理想)";
                    feedbackEl.className = "text-xs text-gray-500 mt-1 italic";
                }
            }
        }

        function setInitialImages() {
            document.getElementById('intro-hero-image').src = assetUrls.hero.normal;
            document.getElementById('survival-hero-image').src = assetUrls.hero.normal;
            document.getElementById('mission-hero-image').src = assetUrls.hero.normal;
            document.getElementById('mission-golem-image').src = assetUrls.golem.normal;
        }

        function getCharacterImage(characterAsset, currentHp, maxHp) {
            const percentage = (currentHp / maxHp) * 100;
            if (percentage < 30) return characterAsset.danger;
            if (percentage < 70) return characterAsset.hurt;
            return characterAsset.normal;
        }

        function setLegend() {
            const legendHtml = `
                <div class="flex items-center gap-1">
                    <span class="w-3 h-3 bg-yellow-400" style="clip-path: polygon(50% 0%, 0% 100%, 100% 100%);"></span>
                    <span>平均 (μ)</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                    <span>±1σ (約68%)</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="w-3 h-3 bg-orange-400 rounded-full"></span>
                    <span>±2σ (約95%)</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                    <span>±3σ (約99.7%)</span>
                </div>`;
            document.getElementById('sim-legend').innerHTML = legendHtml;
        }

        function renderNButtons() {
            nSelector.innerHTML = '';
            nValues.forEach(val => {
                const button = document.createElement('button');
                button.textContent = val;
                button.dataset.n = val;
                button.className = 'n-button';
                nSelector.appendChild(button);
            });
            
            const customNInput = document.createElement('input');
            customNInput.type = 'number';
            customNInput.min = 1;
            customNInput.max = 999;
            customNInput.placeholder = 'n=?';
            customNInput.className = 'n-button w-24 text-center';
            nSelector.appendChild(customNInput);

            document.querySelector(`#n-selector button[data-n='${currentN}']`).classList.add('n-button-selected');
        }

        // --- Event Listeners ---
        Object.keys(modeButtons).forEach(key => {
            modeButtons[key].addEventListener('click', () => switchMode(key));
        });
        
        nSelector.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                currentN = parseInt(e.target.dataset.n, 10);
                document.querySelectorAll('#n-selector button').forEach(btn => btn.classList.remove('n-button-selected'));
                e.target.classList.add('n-button-selected');
                nSelector.querySelector('input').value = '';
                if (currentMode === 'simulation') resetSimulation();
            }
        });

        nSelector.addEventListener('change', (e) => {
            if (e.target.tagName === 'INPUT') {
                let val = parseInt(e.target.value, 10);
                if (isNaN(val) || val < 1) val = 1;
                if (val > 999) val = 999;
                currentN = val;
                e.target.value = val;
                document.querySelectorAll('#n-selector button').forEach(btn => btn.classList.remove('n-button-selected'));
                if (currentMode === 'simulation') resetSimulation();
            }
        });

        weaponSelector.addEventListener('change', () => {
            updateWeaponDisplay();
            if (currentMode === 'simulation') resetSimulation();
        });
        restartSurvivalBtn.addEventListener('click', restartSurvival);
        restartMissionBtn.addEventListener('click', restartMission);
        
        // Column Modal Listeners
        weaponColBtn.addEventListener('click', () => {
            columnText.textContent = "どの武器も一見サイコロの出やすさが異なりますが、期待値（平均）は同じ3.5になるように調整されています。";
            columnModal.classList.remove('hidden');
        });
        nColBtn.addEventListener('click', () => {
            columnText.textContent = "nを大きくすればするほど、平均ダメージの分布は理論上の正規分布（赤い線）に近づいていきます。";
            columnModal.classList.remove('hidden');
        });
        simColBtn.addEventListener('click', () => {
            columnText.textContent = "敵はいないので、心ゆくまで武器とnの組み合わせを試し、グラフがどう変化するかを観察してみましょう！";
            columnModal.classList.remove('hidden');
        });
        survivalColBtn.addEventListener('click', () => {
            columnText.textContent = "君の統計学の知識が生存の鍵だ。分布を整えてボーナスを稼ぎ、どこまで生き残れるか挑戦しよう！";
            columnModal.classList.remove('hidden');
        });
        missionColBtn.addEventListener('click', () => {
            columnText.textContent = "限られたターンの中で、いかに分布を整えて大ダメージを与えるかが攻略の鍵となります。";
            columnModal.classList.remove('hidden');
        });
        meanColBtn.addEventListener('click', () => {
            columnText.textContent = "ダメージ平均は、これまでの君の全攻撃の平均値だ。nを大きくすると、一回ごとのダメージがこの値に近づいていくぞ。";
            columnModal.classList.remove('hidden');
        });
        stddevColBtn.addEventListener('click', () => {
            columnText.textContent = "ばらつき（標準偏差）は、攻撃ダメージがどれだけ平均から離れているかを示す。この値が小さいほど、攻撃が安定している証拠だ！";
            columnModal.classList.remove('hidden');
        });
        closeColumnBtn.addEventListener('click', () => columnModal.classList.add('hidden'));
        columnModal.addEventListener('click', (e) => {
            if (e.target === columnModal) {
                columnModal.classList.add('hidden');
            }
        });


        // --- Initial Call ---
        initializeCharts();
        setInitialImages();
        setLegend();
        renderNButtons();
        switchMode('introduction'); // Start with the introduction tab
        updateWeaponDisplay();
        // Set initial mission text
        document.getElementById('mission-hp-display').textContent = MISSION_HP;
        document.getElementById('mission-turn-display').textContent = MISSION_TURNS;
    });
    </script>
</body>
</html>
